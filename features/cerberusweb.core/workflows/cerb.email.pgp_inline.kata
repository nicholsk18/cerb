workflow:
  name: cerb.email.pgp_inline
  version: 2024-10-14T00:00:00Z
  description: Encrypt messages with PGP and paste them inline in outgoing email
  website: https://cerb.ai/workflows/cerb.email.pgp_inline/
  requirements:
    cerb_version: >=11.0 <11.1
    cerb_plugins: cerberusweb.core

records:
  automation/pgp_encrypt_interaction:
    fields:
      name: cerb.email.pgpInline.interaction
      extension_id: cerb.trigger.interaction.worker
      description: Encrypt messages with PGP and paste them inline in outgoing email
      script@raw:
        start:
          await:
            form:
              title: Encrypt message
              elements:
                textarea/prompt_message:
                  label: Message:
                  required@bool: yes

                sheet/prompt_recipient_keys:
                  label: Recipient public keys:
                  required@bool: yes
                  data:
                    automation:
                      uri: cerb:automation:cerb.data.records
                      inputs:
                        record_type: gpg_public_key
                  limit: 10
                  schema:
                    layout:
                      headings@bool: no
                      paging@bool: yes
                      filtering@bool: yes
                    columns:
                      selection/id:
                        params:
                          mode: multiple
                      card/_label:
                        params:
                          bold@bool: yes

          encrypt.pgp:
            output: encrypted_message
            inputs:
              message@key: prompt_message
              public_keys:
                ids@key: prompt_recipient_keys

          return:
            snippet@key: encrypted_message
      policy_kata@raw:
        commands:
          encrypt.pgp:
            allow: yes

  toolbar_section/reply_pgp:
    fields:
      name: Inline PGP Encryption
      priority: 10
      toolbar_name: mail.reply
      toolbar_kata@raw:
        interaction/encryptWithPGP:
          uri: cerb:automation:cerb.email.pgpInline.interaction
          tooltip: Encrypt with PGP
          icon: message-lock